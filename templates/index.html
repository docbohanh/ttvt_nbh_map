<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>B·∫£n ƒë·ªì khu v·ª±c c√°c TTVT</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

  <div id="map">{{ map_html | safe }}</div>
  <button id="editBtn" onclick="showEditor()">üõ† S·ª≠a TTVT</button>

  <div id="editorModal" class="modal">
    <div class="modal-content">
      <form id="editorForm">
        <div class="modal-header">          
          <br/>
          <h3>Ch·ªânh s·ª≠a TTVT (K√©o th·∫£)</h3>
          <div class="form-actions">
            <button type="submit" class="save-btn"">üíæ L∆∞u</button>
            <button type="button" class="close-btn" onclick="hideEditor()">‚ùå</button>
          </div>
        </div>
        <div id="ttvtEditor" class="editor-container"></div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const defaultTTVT = {{ default_ttvt | safe }};

    function showEditor() {
      const container = document.getElementById("ttvtEditor");
      container.innerHTML = "";
      for (const [group, items] of Object.entries(defaultTTVT)) {
        const div = document.createElement("div");
        div.classList.add("group-block");
        div.innerHTML = `<h4>${group}</h4><ul class="sortable-list"></ul>`;
        const ul = div.querySelector("ul");
        items.forEach(item => {
          const li = document.createElement("li");
          li.textContent = item;
          li.dataset.value = item;
          ul.appendChild(li);
        });
        container.appendChild(div);
        new Sortable(ul, { group: 'shared', animation: 150 });
      }
      document.getElementById("editorModal").style.display = "block";
    }

    function hideEditor() {
      document.getElementById("editorModal").style.display = "none";
    }

    document.getElementById("editorForm").addEventListener("submit", async e => {
      e.preventDefault();
      const result = {};
      document.querySelectorAll(".group-block").forEach(block => {
        const group = block.querySelector("h4").innerText;
        const items = Array.from(block.querySelectorAll("li")).map(li => li.dataset.value);
        result[group] = items;
      });
      const res = await fetch("/update_ttvt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(result)
      });
      if (res.ok) location.reload();
      else alert("L∆∞u th·∫•t b·∫°i!");
    });
  </script>

<div style="position:fixed;bottom:20px;right:180px;z-index:10001;">
  <a href="/export_ttvt_json" id="exportExcelBtn" style="
    display:inline-block;
    padding:10px 18px;
    background:#28a745;
    color:white;
    border-radius:6px;
    font-size:16px;
    text-decoration:none;
    font-weight:600;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    ">
    ‚¨á TTVT JSON
  </a>
</div>
</body>
</html>
